<!doctype html>
<html lang="en">
  <head>
    <title>NSFW</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="main.css">
  </head>
  <body>
    <div id="player"></div>
    <div class="general-container" id="app">
      <transition name="fade">
        <div class="general-button__container" v-show="!isOn">
          <button class="general-button primary" @click="init">Trust me</button>
        </div>
      </transition>
      <general-canvas ref="generalCanvas" :width="width" :height="height"></general-canvas>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
      var tag = document.createElement('script')
      tag.src = "https://www.youtube.com/iframe_api"
      var firstScriptTag = document.getElementsByTagName('script')[0]
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag)
      const urlParams = new URLSearchParams(window.location.search)
      var player = null;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '1',
          width: '1',
          videoId: urlParams.get('v') ? urlParams.get('v') : 'I_izvAbhExY',
          events: {
            'onStateChange': onPlayerStateChange
          }
        });
      }
      function onPlayerStateChange (event) {
        if (event.data == YT.PlayerState.PLAYING) {
          // player.mute()
          app.$refs.generalCanvas.init()
        }
      }
    </script>
    <script>
      Vue.component('general-canvas', {
        template: '<canvas ref="canvasElement" class="general-canvas" :width="width" :height="height"></canvas>',
        props: ['width', 'height'],
        data: function () {
          return {
            isMounted: false,
            canvasElement: {},
            canvas: {},
            sprites: [],
            elements: [],
            mainElement: {},
            mainBackground: {},
            mainBorder: {}
          }
        },
        mounted: function () {
          this.canvasElement = this.$refs.canvasElement
          this.canvas = this.canvasElement.getContext('2d')
          this.loadSprites()
          this.isMounted = true
        },
        methods: {
          loadSprites() {
            switch (urlParams.get('c')) {
              case 'doggy':
                for (var i = 0; i < 48; i++) {
                  var img = new Image();
                  img.src = 'sprites/michael/sprite_'+i+'.png'
                  this.sprites.push(img)
                }
                break;
              default:
                for (var i = 0; i < 48; i++) {
                  var img = new Image();
                  img.src = 'sprites/michael/sprite_'+i+'.png'
                  this.sprites.push(img)
                }
                break;
            }
          },
          init() {
            this.mainElement = this.createMainElement()
            this.mainBackground = this.createMainBackground()
            this.mainBorder = this.createMainBorder()
            this.elements = this.createElements()
            setInterval(() => {
              this.renderCanvas()
            }, 90)
          },
          renderCanvas() {
            this.canvas.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height)
            this.mainBackground.render()     
            this.elements.forEach(element => {
              element.render()
            })
            this.mainBorder.render() 
            this.mainElement.render()
          },
          createMainElement() {
            let element = this.newElement()
            element.render = this.render(element, () => {
              element.width = this.height
              element.height = this.height
              element.x = (this.width - element.width) / 2
              this.canvas.globalAlpha = 1;
              this.canvas.drawImage(element.sprites[element.currentSprite], element.x, 0, element.width, element.height)
            })
            return element
          },
          createMainBackground() {
            return this.newBackground()
          },
          createMainBorder() {
            return this.newBorder()
          },
          createElements() {
            let elements = []
            elements.push(this.newElement(this.getRnd(0.4, 0.9), 400, 0, 300, 1, 3))
            elements.push(this.newElement(this.getRnd(0.4, 0.9), 600, 0, 300, -1, 3))
            return elements
          },
          newElement(opacity = 1, x = 600, y = 0, size = 300, direction = 1, speed = 10) {
            let element = {}
            element.sprites = [...this.sprites]
            element.currentSprite = this.getRndInteger(0, element.sprites.length)
            element.totalSprite = element.sprites.length
            element.opacity = opacity
            element.x = x
            element.y = y
            element.width = size
            element.height = size
            element.direction = direction
            element.speed = speed
            element.render = this.render(element, () => {
              element.x += element.speed * element.direction
              this.canvas.globalAlpha = element.opacity;
              this.canvas.drawImage(element.sprites[element.currentSprite], element.x, element.y, element.width, element.height)
            })
            return element
          },
          newBackground() {
            let element = {}
            element.currentSprite = 0
            element.totalSprite = 3
            element.colors = ["Yellow",  "YellowGreen", "Tomato", "Red", "Coral", "Blue", "Chartreuse", "Black"]
            element.render = this.render(element, () => {
              if(element.currentSprite === 0) {
                this.canvas.fillStyle = element.colors[this.getRndInteger(0, element.colors.length)]
              }
              this.canvas.fillRect(0, 0, this.canvasElement.width, this.canvasElement.height)
            })
            return element
          },
          newBorder() {
            let element = {}
            element.currentSprite = 0
            element.totalSprite = 3
            element.colors = ["Yellow",  "YellowGreen", "Tomato", "Red", "Coral", "Blue", "Chartreuse", "Black"]
            element.render = this.render(element, () => {
              if(element.currentSprite === 0) {
                this.canvas.strokeStyle = element.colors[this.getRndInteger(0, element.colors.length)]
              }
              this.canvas.beginPath()
              this.canvas.lineWidth = "50"
              this.canvas.rect(0, 0, this.canvasElement.width, this.canvasElement.height)
              this.canvas.stroke()
            })
            return element
          },
          render(element, callback) {
            return () => {
              callback()
              element.currentSprite++
              if(element.currentSprite == element.totalSprite) {
                element.currentSprite = 0
              }
            }
          },
          getRndInteger(min, max) {
            return Math.floor(Math.random() * (max - min) ) + min
          },
          getRnd(min, max) {
            return Math.random() * (max - min) + min
          }
        }
      })
      
      var app = new Vue({
        el: '#app',
        data: function () {
          return {
            isOn: false,
            isMounted: false,
            width: window.innerWidth,
            height: window.innerHeight
          }
        },
        mounted: function () {
          window.addEventListener('resize', this.resizeController, { passive: true })
          this.isMounted = true
        },
        beforeDestroy: function () {
          window.removeEventListener('scroll', this.scrollController, { passive: true })
          window.removeEventListener('resize', this.resizeController, { passive: true })
        },
        methods: {
          resizeController() {
            if (this.isMounted) {
              this.width = window.innerWidth
              this.height = window.innerHeight
              if(this.width > 768 && this.isHamburguerActive) {
                this.isHamburguerActive = !this.isHamburguerActive
              }
            }
          },
          init() {
            this.isOn = true
            player.playVideo()
          }
        }
      })
    </script>
  </body>
</html>